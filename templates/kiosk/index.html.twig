{% extends 'kiosk/kiosk-base.html.twig' %}
{#
todo: ios doesn't allow playing audio until the user has interacted with the page somehow
    If we want to enable a "successful scan" beep we'll need to:
        - have some kind of "start scanning" button for a kiosk admin to click
        - use ajax calls so we never leave the page (since that would reset the permission)
#}

{% block page_title %}COVIDTrack Kiosk{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-md-12">
            {{
                form(form, {
                    'attr': {
                        'autocomplete': 'off',
                    }
                })
            }}
        </div>
    </div>

    {%  include 'kiosk/scan-help.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        // Scanner input detection
        (function($) {
            var _timeoutHandler = 0,
                _inputString = '',
                _onKeypress = function(e) {
                    if (_timeoutHandler) {
                        clearTimeout(_timeoutHandler);
                    }

                    if(e.key !== "Enter") {
                        _inputString += e.key;
                    }

                    _timeoutHandler = setTimeout(function () {
                        if (_inputString.length <= 3) {
                            _inputString = '';
                            return;
                        }
                        console.log(_inputString);
                        $(e.target).trigger('scannerinput', _inputString);
                        _inputString = '';

                    }, 50); //iPad seems to like 50ms.
                };
            $(document).on({
                keypress: _onKeypress
            });
        })($);

        // What to do when scanner input

        $(document).on( "scannerinput", function(e, inputString) {
            if ($("option:contains(" + inputString + ")", "[data-scanner-input]").length === 0) {
                console.log('Not an option');
                alert('not an option:' + inputString);
                return;
            }

            let selection = "";
            selection = $("option:contains(" + inputString + ")", "[data-scanner-input]").val();

            $("[data-scanner-input]").val(selection);
            $("[data-scanner-input]").parents('form').submit();
        });
    </script>
{% endblock %}